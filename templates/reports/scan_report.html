<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>{{ app_name }} — Scan Report</title>

<style>
  @page { size: A4; margin: 16mm; }
  :root{
    --bg:#0f1220; --card:#151a2f; --muted:#8b93a7; --ink:#e9ecf1;
    --accent:#5b8cff; --border:#232a44; --bad:#ef4444; --warn:#f59f00; --info:#7dd3fc;
  }
  html, body { background: var(--bg); color: var(--ink); font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
  body { margin:0; }
  .wrap{ max-width: 980px; margin: 0 auto; }
  .header{ display:flex; justify-content:space-between; align-items:center; padding:16px 20px; border:1px solid var(--border); border-radius:12px; background:linear-gradient(135deg,#11162b,#0e1330 55%,#0a0f29); }
  .brand{ font-weight:800; letter-spacing:.4px }
  .badge{ font-size:12px; color:#cbd5e1; background:#1e273f; padding:6px 10px; border-radius:9999px; border:1px solid var(--border); margin-left:8px }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px 16px; margin-top:12px; box-shadow:0 3px 10px rgba(2,6,23,.3) }
  h1{ margin:.2rem 0 0.5rem 0; font-size:24px }
  h2{ margin:0 0 8px; font-size:16px; color:#dbe4ff }
  .sub{ color:var(--muted); font-size:12px }
  .grid{ display:grid; gap:12px }
  .cols-3{ grid-template-columns:repeat(3,1fr) }
  .kpi{ display:flex; justify-content:space-between; align-items:center }
  .kpi .n{ font-size:26px; font-weight:800 }
  .tag{ font-size:11px; padding:4px 8px; border-radius:9999px; border:1px solid var(--border); background:#1a2141; color:#cbd5e1 }
  .sevbar{ display:flex; height:10px; border-radius:8px; overflow:hidden; border:1px solid var(--border); margin-top:6px }
  .sevbar div{ height:100% }
  .sev-crit{ background:var(--bad) }
  .sev-high{ background:#fb923c }
  .sev-med{ background:var(--warn) }
  .sev-low{ background:#60a5fa }
  .sev-info{ background:var(--info) }
  table{ width:100%; border-collapse:separate; border-spacing:0 6px }
  th{ font-size:12px; color:#cbd5e1; text-align:left; padding:6px 8px }
  td{ font-size:12px; color:#e5e7eb; padding:10px 12px; background:#141935; border:1px solid var(--border) }
  tr td:first-child{ border-top-left-radius:10px; border-bottom-left-radius:10px }
  tr td:last-child{ border-top-right-radius:10px; border-bottom-right-radius:10px }
  .pill{ display:inline-block; font-size:11px; padding:3px 8px; border-radius:9999px; border:1px solid var(--border) }
  .open{ background:rgba(32,201,151,.08); color:#86efac; border-color:#115e59 }
  .closed{ background:#1e293b; color:#cbd5e1 }
  .filtered{ background:#1e1b4b; color:#ddd6fe }
  .panel{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
  .accent{ color:var(--accent) }
  .foot{ margin:14px 0; color:var(--muted); font-size:11px; text-align:center }
  .m0{ margin:0 }
  .mt12{ margin-top:12px }
</style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <div class="header">
    <div class="brand">{{ logo_text }}</div>
    <div>
      <span class="badge">Scan Report</span>
      <span class="badge">Generated {{ generated_at|date:"Y-m-d H:i" }}</span>
    </div>
  </div>

  <!-- Title -->
  <div class="card">
    <h1>Results for <span class="accent">{{ scan.target }}</span></h1>
    <div class="sub">
      Type: {{ scan.type|capfirst }} • Status: {{ scan.status|capfirst }}
      • Started: {{ scan.createdAt|default:"—" }}
      • Finished: {{ scan.finishedAt|default:"—" }}
      • Duration: {{ duration|default:"—" }}
    </div>
  </div>

  <!-- KPIs -->
  <div class="grid cols-3">
    <div class="card kpi">
      <div>
        <div class="sub">Total Findings</div>
        <div class="n">{{ sev.total|default:"0" }}</div>
      </div>
      <span class="tag">Vulnerabilities</span>
    </div>

    <div class="card kpi">
      <div>
        <div class="sub">Open Ports</div>
        <div class="n">{{ open_ports_total|default:"0" }}</div>
      </div>
      <span class="tag">Network</span>
    </div>

    <div class="card kpi">
      <div>
        <div class="sub">Hosts Scanned</div>
        <div class="n">{{ scan.results.summary.hostsScanned|default:"1" }}</div>
      </div>
      <span class="tag">Scope</span>
    </div>
  </div>

  <!-- Severity Overview -->
  <div class="card">
    <h2>Severity Overview</h2>
    <div class="sevbar">
      <div class="sev-crit" style="width:{{ widths.critical }}%"></div>
      <div class="sev-high" style="width:{{ widths.high }}%"></div>
      <div class="sev-med"  style="width:{{ widths.medium }}%"></div>
      <div class="sev-low"  style="width:{{ widths.low }}%"></div>
      <div class="sev-info" style="width:{{ widths.info }}%"></div>
    </div>
    <div class="sub">
      Critical: {{ sev.critical|default:"0" }} •
      High: {{ sev.high|default:"0" }} •
      Medium: {{ sev.medium|default:"0" }} •
      Low: {{ sev.low|default:"0" }} •
      Info: {{ sev.info|default:"0" }}
    </div>
  </div>

  <!-- Host block -->
  {% if hosts %}
  {% with host=hosts.0 %}
  <div class="card">
    <h2>Host: <span>{{ host.ip }}</span> — <span class="tag">{% if host.reachable %}Reachable{% else %}Unreachable{% endif %}</span></h2>

    <h3 class="sub m0 mt12">Ports</h3>
    <table>
      <thead><tr><th>Port</th><th>Protocol</th><th>State</th><th>Service</th><th>Banner</th></tr></thead>
      <tbody>
        {% if host.ports %}
          {% for p in host.ports %}
          <tr>
            <td>{{ p.port }}</td>
            <td>{{ p.protocol|default:"tcp"|upper }}</td>
            <td>
              <span class="pill {% if p.state == 'open' %}open{% elif p.state == 'filtered' %}filtered{% else %}closed{% endif %}">
                {{ p.state|default:"unknown"|capfirst }}
              </span>
            </td>
            <td>{{ p.service|default:"—" }}</td>
            <td>{% if p.banner %}{{ p.banner }}{% else %}—{% endif %}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="5">No port data.</td></tr>
        {% endif %}
      </tbody>
    </table>

    <div class="panel">
      <div class="card">
        <h2>HTTP</h2>
        <div class="sub">
          {% if host.http %}
            Status: {{ host.http.status|default:"—" }} • Server: {{ host.http.server|default:"—" }}<br>
            Title: {{ host.http.title|default:"—" }}<br>
            robots.txt:
            {% if host.http.robots and host.http.robots.present %}
              Found{% if host.http.robots.path %} at {{ host.http.robots.path }}{% endif %}
            {% else %}
              Not found
            {% endif %}<br>
            HSTS: {% if host.http.hsts %}Yes{% else %}No{% endif %} • CSP: {{ host.http.csp|default:"—" }}
          {% else %}
            No HTTP data.
          {% endif %}
        </div>
      </div>

      <div class="card">
        <h2>TLS</h2>
        <div class="sub">
          {% if host.tls and host.tls.present %}
            Valid: {% if host.tls.valid %}Yes{% else %}No{% endif %} • Issuer: {{ host.tls.issuer|default:"—" }}<br>
            Not Before: {{ host.tls.notBefore|default:"—" }} • Not After: {{ host.tls.notAfter|default:"—" }}<br>
            SANs:
            {% if host.tls.sans %}
              {{ host.tls.sans|join:", " }}
            {% else %}
              —
            {% endif %}
          {% else %}
            No TLS info.
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endwith %}
  {% endif %}

  <!-- Vulnerabilities -->
  <div class="card" style="page-break-inside: avoid;">
    <h2>Vulnerabilities</h2>
    <table>
      <thead>
        <tr>
          <th>Severity</th><th>Vulnerability</th><th>Affected</th><th>Description</th><th>Remediation</th>
        </tr>
      </thead>
      <tbody>
        {% if vulns %}
          {% for v in vulns %}
          <tr>
            <td>
              <span class="pill open">{{ v.severity|default:"info"|upper }}</span>
            </td>
            <td>{{ v.name|default:"—" }}</td>
            <td>{{ v.host }}{{ v.path }}</td>
            <td>
              {{ v.description|default:"—" }}
              {% if v.references and v.references|length %}
                <div class="sub" style="margin-top:6px">
                  References:
                  {% for r in v.references %}
                    <span>{{ r }}</span>{% if not forloop.last %}, {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            </td>
            <td>{{ v.remediation|default:"—" }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="5">No vulnerabilities recorded.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <div class="foot">© {{ app_name }} — Generated for {{ user_name|default:"User" }}</div>
</div>
</body>
</html>
